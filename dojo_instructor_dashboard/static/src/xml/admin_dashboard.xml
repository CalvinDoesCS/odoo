<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

<t t-name="dojo_instructor_dashboard.AdminDashboard">
<div class="o_di_root" t-ref="root">

    <!-- ═══════════════════════════════════════════════════════════
         LOADING
    ═══════════════════════════════════════════════════════════ -->
    <t t-if="state.loading">
        <div class="d-flex justify-content-center align-items-center" style="min-height:360px">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading…</span>
            </div>
        </div>
    </t>

    <!-- Dashboard content -->
    <t t-else="">

        <!-- ── Admin Hero Banner ─────────────────────────────────── -->
        <div class="o_ad_banner">
            <div class="o_ad_banner_inner">
                <div class="o_ad_banner_left">
                    <div class="o_ad_banner_icon">
                        <i class="fa fa-tachometer"/>
                    </div>
                    <div>
                        <div class="o_ad_banner_label">Admin Overview</div>
                        <div class="o_ad_banner_title">Dojo Dashboard</div>
                        <div class="o_di_date" t-esc="todayLabel"/>
                    </div>
                </div>
                <div class="o_ad_banner_actions">
                    <button class="o_ad_hdr_btn" t-on-click="openTodaysSessions">
                        <i class="fa fa-calendar-check-o me-1"/>Today's Sessions
                    </button>
                    <button class="o_ad_hdr_btn" t-on-click="openCalendar">
                        <i class="fa fa-calendar me-1"/>Calendar
                    </button>
                    <button class="o_ad_hdr_btn" t-on-click="openAllStudents">
                        <i class="fa fa-users me-1"/>All Students
                    </button>
                    <button class="o_ad_hdr_btn o_ad_hdr_btn_refresh" t-on-click="_reload">
                        <i class="fa fa-refresh"/>
                    </button>
                </div>
            </div>
        </div>

        <!-- ── Summary KPI Tiles ─────────────────────────────────── -->
        <div class="o_di_kpi_row o_ad_kpi_row" t-if="state.summary">

            <div class="o_di_kpi_card o_ad_kpi_indigo" t-on-click="openInstructorKpis" style="cursor:pointer">
                <div class="o_di_kpi_icon"><i class="fa fa-chalkboard-teacher fa-fw"/></div>
                <div class="o_di_kpi_body">
                    <div class="o_di_kpi_value" t-esc="state.summary.total_instructors"/>
                    <div class="o_di_kpi_label">Instructors</div>
                </div>
            </div>

            <div class="o_di_kpi_card o_di_kpi_green" t-on-click="openAllStudents" style="cursor:pointer">
                <div class="o_di_kpi_icon"><i class="fa fa-users fa-fw"/></div>
                <div class="o_di_kpi_body">
                    <div class="o_di_kpi_value" t-esc="state.summary.total_active_students"/>
                    <div class="o_di_kpi_label">Active Students</div>
                </div>
            </div>

            <div class="o_di_kpi_card o_di_kpi_blue" t-on-click="openTodaysSessions" style="cursor:pointer">
                <div class="o_di_kpi_icon"><i class="fa fa-calendar-check-o fa-fw"/></div>
                <div class="o_di_kpi_body">
                    <div class="o_di_kpi_value" t-esc="state.summary.sessions_today"/>
                    <div class="o_di_kpi_label">Sessions Today</div>
                </div>
            </div>

            <div class="o_di_kpi_card o_di_kpi_orange">
                <div class="o_di_kpi_icon"><i class="fa fa-bar-chart fa-fw"/></div>
                <div class="o_di_kpi_body">
                    <div class="o_di_kpi_value">
                        <t t-esc="pct(state.summary.overall_fill_rate)"/>
                    </div>
                    <div class="o_di_kpi_label">Avg Fill Rate</div>
                    <div class="o_di_kpi_sub">last 30 days</div>
                </div>
            </div>

            <div class="o_di_kpi_card o_di_kpi_purple">
                <div class="o_di_kpi_icon"><i class="fa fa-check-circle fa-fw"/></div>
                <div class="o_di_kpi_body">
                    <div class="o_di_kpi_value">
                        <t t-esc="pct(state.summary.overall_attendance_rate)"/>
                    </div>
                    <div class="o_di_kpi_label">Attendance Rate</div>
                    <div class="o_di_kpi_sub">last 30 days</div>
                </div>
            </div>

            <div class="o_di_kpi_card o_ad_kpi_red">
                <div class="o_di_kpi_icon"><i class="fa fa-user-times fa-fw"/></div>
                <div class="o_di_kpi_body">
                    <div class="o_di_kpi_value" t-esc="state.summary.total_dropped_60d"/>
                    <div class="o_di_kpi_label">Dropped Enrollments</div>
                    <div class="o_di_kpi_sub">last 60 days</div>
                </div>
            </div>

        </div>

        <!-- ── Content Grid ─────────────────────────────────────── -->
        <div class="o_di_content_grid o_ad_content_grid">

            <!-- ════════ Instructor Performance Table ════════ -->
            <div class="o_di_card o_di_card_full">
                <div class="o_di_card_header">
                    <div class="o_di_card_title">
                        <span class="o_di_card_dot" style="background:#6f42c1"/>
                        Instructor Performance
                        <small class="text-muted fw-normal ms-1">last 30 days</small>
                    </div>
                    <button class="o_di_view_btn" t-on-click="openInstructorKpis">View All</button>
                </div>
                <div class="o_di_card_body">
                    <t t-if="state.instructors.length === 0">
                        <div class="o_di_empty">
                            <i class="fa fa-users fa-2x mb-2"/>
                            <div>No instructor profiles found</div>
                        </div>
                    </t>
                    <t t-else="">
                        <table class="o_di_table">
                            <thead>
                                <tr>
                                    <th>Instructor</th>
                                    <th class="text-center">Classes Today</th>
                                    <th class="text-center">Total Students</th>
                                    <th style="min-width:140px">Fill Rate (30d)</th>
                                    <th style="min-width:140px">Attendance (30d)</th>
                                    <th/>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="state.instructors" t-as="inst" t-key="inst.id">
                                    <tr>
                                        <td class="fw-semibold">
                                            <t t-esc="inst.name"/>
                                        </td>
                                        <td class="text-center">
                                            <span t-attf-class="o_di_badge {{ inst.sessions_today > 0 ? 'o_di_badge_success' : 'o_di_badge_secondary' }}">
                                                <t t-esc="inst.sessions_today"/>
                                            </span>
                                        </td>
                                        <td class="text-center fw-semibold">
                                            <t t-esc="inst.students_count"/>
                                        </td>
                                        <td>
                                            <div class="o_ad_bar_wrap">
                                                <div class="o_ad_bar_bg">
                                                    <div t-attf-class="o_ad_bar_fill {{ rateClass(inst.fill_rate) }}"
                                                         t-att-style="barFill(inst.fill_rate)"/>
                                                </div>
                                                <span t-attf-class="o_ad_bar_label {{ rateClass(inst.fill_rate) }}">
                                                    <t t-esc="pct(inst.fill_rate)"/>
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="o_ad_bar_wrap">
                                                <div class="o_ad_bar_bg">
                                                    <div t-attf-class="o_ad_bar_fill {{ rateClass(inst.attendance_rate) }}"
                                                         t-att-style="barFill(inst.attendance_rate)"/>
                                                </div>
                                                <span t-attf-class="o_ad_bar_label {{ rateClass(inst.attendance_rate) }}">
                                                    <t t-esc="pct(inst.attendance_rate)"/>
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="o_di_view_btn"
                                                    t-on-click="() => openInstructorRecord(inst.id)">
                                                View
                                            </button>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </t>
                </div>
            </div>

            <!-- ════════ Recent Sessions Analytics ════════ -->
            <div class="o_di_card o_di_card_full">
                <div class="o_di_card_header">
                    <div class="o_di_card_title">
                        <span class="o_di_card_dot" style="background:#0d6efd"/>
                        Recent Sessions
                        <small class="text-muted fw-normal ms-1">last 30 days</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="o_di_view_btn" t-on-click="openCalendar">
                            <i class="fa fa-calendar me-1"/>Calendar
                        </button>
                        <t t-if="state.recentSessions.length > 15">
                            <button class="o_di_view_btn" t-on-click="toggleSessions">
                                <t t-esc="state.sessionsExpanded ? 'Show Less' : 'Show All (' + state.recentSessions.length + ')'"/>
                            </button>
                        </t>
                    </div>
                </div>
                <div class="o_di_card_body">
                    <t t-if="state.recentSessions.length === 0">
                        <div class="o_di_empty">
                            <i class="fa fa-calendar-o fa-2x mb-2"/>
                            <div>No recent sessions</div>
                        </div>
                    </t>
                    <t t-else="">
                        <table class="o_di_table">
                            <thead>
                                <tr>
                                    <th>Class</th>
                                    <th>Instructor</th>
                                    <th>Date</th>
                                    <th class="text-center">Cap.</th>
                                    <th class="text-center">Enrolled</th>
                                    <th class="text-center">Present</th>
                                    <th class="text-center">Absent</th>
                                    <th style="min-width:110px">Fill Rate</th>
                                    <th style="min-width:110px">Attendance</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="visibleSessions" t-as="s" t-key="s.id">
                                    <tr>
                                        <td class="fw-semibold"><t t-esc="s.class_name"/></td>
                                        <td class="text-muted"><t t-esc="s.instructor_name"/></td>
                                        <td class="text-muted text-nowrap"><t t-esc="fmtDate(s.date)"/></td>
                                        <td class="text-center"><t t-esc="s.capacity"/></td>
                                        <td class="text-center"><t t-esc="s.enrolled"/></td>
                                        <td class="text-center text-success fw-semibold">
                                            <t t-esc="s.present"/>
                                        </td>
                                        <td class="text-center text-danger fw-semibold">
                                            <t t-esc="s.absent"/>
                                        </td>
                                        <td>
                                            <div class="o_ad_bar_wrap">
                                                <div class="o_ad_bar_bg">
                                                    <div t-attf-class="o_ad_bar_fill {{ rateClass(s.fill_rate) }}"
                                                         t-att-style="barFill(s.fill_rate)"/>
                                                </div>
                                                <span t-attf-class="o_ad_bar_label {{ rateClass(s.fill_rate) }}">
                                                    <t t-esc="pct(s.fill_rate)"/>
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <t t-if="s.attendance_rate !== null">
                                                <div class="o_ad_bar_wrap">
                                                    <div class="o_ad_bar_bg">
                                                        <div t-attf-class="o_ad_bar_fill {{ rateClass(s.attendance_rate) }}"
                                                             t-att-style="barFill(s.attendance_rate)"/>
                                                    </div>
                                                    <span t-attf-class="o_ad_bar_label {{ rateClass(s.attendance_rate) }}">
                                                        <t t-esc="pct(s.attendance_rate)"/>
                                                    </span>
                                                </div>
                                            </t>
                                            <t t-else="">
                                                <span class="text-muted">—</span>
                                            </t>
                                        </td>
                                        <td>
                                            <span t-attf-class="o_di_badge {{ stateBadgeClass(s.state) }}">
                                                <t t-esc="stateLabel(s.state)"/>
                                            </span>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </t>
                </div>
            </div>

            <!-- ════════ Dropped / Cancelled Students ════════ -->
            <div class="o_di_card o_di_card_full">
                <div class="o_di_card_header">
                    <div class="o_di_card_title">
                        <span class="o_di_card_dot" style="background:#dc3545"/>
                        Dropped Enrollments
                        <small class="text-muted fw-normal ms-1">last 60 days</small>
                    </div>
                    <div class="d-flex gap-2">
                        <t t-if="state.droppedStudents.length > 10">
                            <button class="o_di_view_btn" t-on-click="toggleDropped">
                                <t t-esc="state.droppedExpanded ? 'Show Less' : 'Show All (' + state.droppedStudents.length + ')'"/>
                            </button>
                        </t>
                    </div>
                </div>
                <div class="o_di_card_body">
                    <t t-if="state.droppedStudents.length === 0">
                        <div class="o_di_empty">
                            <i class="fa fa-user-times fa-2x mb-2" style="color:#28a745"/>
                            <div>No dropped enrollments in the last 60 days</div>
                        </div>
                    </t>
                    <t t-else="">
                        <table class="o_di_table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Membership</th>
                                    <th>Class</th>
                                    <th>Instructor</th>
                                    <th>Session Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="visibleDropped" t-as="d" t-key="d.member_id + '_' + d_index">
                                    <tr>
                                        <td class="fw-semibold"><t t-esc="d.member_name"/></td>
                                        <td>
                                            <span t-attf-class="o_di_badge {{ membershipBadgeClass(d.membership_state) }}">
                                                <t t-esc="membershipLabel(d.membership_state)"/>
                                            </span>
                                        </td>
                                        <td><t t-esc="d.class_name"/></td>
                                        <td class="text-muted"><t t-esc="d.instructor_name"/></td>
                                        <td class="text-muted text-nowrap">
                                            <t t-esc="fmtDate(d.session_date)"/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </t>
                </div>
            </div>

        </div><!-- /.o_ad_content_grid -->
    </t><!-- /t-else -->

</div><!-- /.o_di_root -->
</t>

</templates>
