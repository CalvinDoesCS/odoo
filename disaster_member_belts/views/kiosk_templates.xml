<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================
         Main kiosk screen
    ================================================================ -->
    <template id="kiosk_main" name="Dojo Kiosk â€“ Check In">
        <t t-call="web.layout">
            <!-- FIX: web.layout renders 't-set="head"', not head_stylesheet -->
            <t t-set="head">
                <link rel="stylesheet" href="/disaster_member_belts/static/src/css/kiosk.css"/>
            </t>
            <t t-set="title">Dojo Check-In Kiosk</t>
        <div id="kiosk-root" class="kiosk-root">

            <!-- Header -->
            <div class="kiosk-header">
                <div class="kiosk-logo">
                    <img src="/disaster_member_belts/static/src/img/portal-dojo.svg" alt="Dojo"/>
                </div>
                <div class="kiosk-title">Check In</div>
                <!-- Session selector -->
                <div class="kiosk-session-selector">
                    <t t-if="sessions">
                        <select id="kiosk-session-select" onchange="kioskSelectSession(this.value)">
                            <t t-foreach="sessions" t-as="s">
                                <option t-att-value="s.id"
                                        t-att-selected="s.id == selected_session.id">
                                    <t t-esc="s.name"/> â€”
                                    <t t-esc="s.date_start" t-options='{"widget":"datetime","format":"HH:mm"}'/>
                                </option>
                            </t>
                        </select>
                    </t>
                    <t t-else="">
                        <span class="kiosk-no-session">No classes scheduled today</span>
                    </t>
                </div>
                <!-- Exit button (top-right) -->
                <div class="kiosk-header-actions">
                    <a href="/dojo/kiosk/instructor" onclick="return kioskOpenInstructor(event)"
                       class="kiosk-instructor-btn" title="Instructor Mode">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        Staff
                    </a>
                    <a href="/dojo/kiosk" class="kiosk-exit-btn" title="Back to Kiosk Home">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Mode tabs -->
            <div class="kiosk-mode-tabs">
                <button class="kiosk-mode-tab active" id="tab-barcode"
                        onclick="kioskSetMode('barcode')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="3" height="16"/><rect x="7" y="4" width="1.5" height="16"/>
                        <rect x="11" y="4" width="3" height="16"/><rect x="17" y="4" width="1.5" height="16"/>
                        <rect x="21" y="4" width="2" height="16"/>
                    </svg>
                    Barcode / Badge
                </button>
                <button class="kiosk-mode-tab" id="tab-pin"
                        onclick="kioskSetMode('pin')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    PIN Number
                </button>
                <button class="kiosk-mode-tab" id="tab-name"
                        onclick="kioskSetMode('name')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    Search by Name
                </button>
            </div>

            <!-- â”€â”€ BARCODE mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="kiosk-barcode-area" class="kiosk-checkin-area">
                <div class="kiosk-barcode-prompt">
                    <div class="kiosk-barcode-icon">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#c9a96e" stroke-width="1.5">
                            <rect x="1" y="4" width="3" height="16"/>
                            <rect x="7" y="4" width="1.5" height="16"/>
                            <rect x="11" y="4" width="3" height="16"/>
                            <rect x="17" y="4" width="1.5" height="16"/>
                            <rect x="21" y="4" width="2" height="16"/>
                        </svg>
                    </div>
                    <div class="kiosk-barcode-text">Scan your badge or membership card</div>
                    <div class="kiosk-barcode-sub">Point the scanner at the barcode on your card</div>
                    <!-- Hidden input captures scanner keystrokes -->
                    <input id="kiosk-barcode-input" type="text"
                           class="kiosk-barcode-hidden-input"
                           autocomplete="off" autocorrect="off" spellcheck="false"
                           aria-hidden="true" tabindex="-1"/>
                </div>
            </div>

            <!-- â”€â”€ PIN mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="kiosk-pin-area" class="kiosk-checkin-area" style="display:none">
                <div class="kiosk-member-pin-card">
                    <div class="kiosk-pin-area-title">Enter your PIN</div>

                    <!-- PIN dots display (4-digit fixed) -->
                    <div class="kiosk-member-pin-dots" id="member-pin-dots">
                        <span class="member-pin-dot" id="mpd-0"/>
                        <span class="member-pin-dot" id="mpd-1"/>
                        <span class="member-pin-dot" id="mpd-2"/>
                        <span class="member-pin-dot" id="mpd-3"/>
                    </div>

                    <div id="member-pin-error" class="kiosk-member-pin-error" style="display:none">
                        PIN not recognised â€” try again or ask staff.
                    </div>

                    <!-- Number pad (same style as staff PIN) -->
                    <div class="kiosk-numpad">
                        <t t-foreach="[1,2,3,4,5,6,7,8,9,'',0,'back']" t-as="key">
                            <button t-if="key != ''" type="button"
                                    t-attf-class="kiosk-num-btn #{key == 'back' and 'kiosk-del-btn' or ''}"
                                    t-att-data-key="key"
                                    onclick="kioskMemberPinKey(this.dataset.key)">
                                <t t-if="key == 'back'">&#8592;</t>
                                <t t-else=""><t t-esc="key"/></t>
                            </button>
                            <div t-else="" class="kiosk-num-empty"/>
                        </t>
                    </div>
                </div>
            </div>

            <!-- â”€â”€ NAME SEARCH mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="kiosk-name-area" class="kiosk-checkin-area" style="display:none">
                <div class="kiosk-search-area"
                     t-att-data-session="selected_session.id if selected_session else ''">
                    <div class="kiosk-search-box">
                        <svg class="kiosk-search-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        <input id="kiosk-name-input"
                               type="text"
                               class="kiosk-name-input"
                               placeholder="Type your name to check inâ€¦"
                               autocomplete="off"
                               autocorrect="off"
                               spellcheck="false"/>
                        <button class="kiosk-clear-btn" id="kiosk-clear"
                                onclick="kioskClear()" style="display:none">âœ•</button>
                    </div>
                    <!-- Search results -->
                    <div id="kiosk-results" class="kiosk-results" style="display:none"></div>
                    <!-- Idle prompt -->
                    <div id="kiosk-idle" class="kiosk-idle">
                        <div class="kiosk-idle-belt">ðŸ¥‹</div>
                        <div class="kiosk-idle-text">Tap the box above and type your name</div>
                    </div>
                </div>
            </div>

            <!-- ============================================================
                 Class Select overlay (shown after member identified)
            ============================================================ -->
            <div id="kiosk-class-select" class="kiosk-overlay" style="display:none">
                <div class="kiosk-cs-card">

                    <!-- Member identity section -->
                    <div class="kiosk-cs-member">
                        <img id="kiosk-cs-avatar" src="" alt="" class="kiosk-cs-avatar"/>
                        <div class="kiosk-cs-info">
                            <div id="kiosk-cs-name" class="kiosk-cs-name"></div>
                            <div id="kiosk-cs-belt" class="kiosk-cs-belt"></div>
                        </div>
                        <button class="kiosk-not-me-btn" onclick="kioskNotMe()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                            This is not me
                        </button>
                    </div>

                    <div class="kiosk-cs-body">
                        <!-- Left: class selection -->
                        <div class="kiosk-cs-left">
                            <div class="kiosk-cs-section-title">Choose your class</div>
                            <div id="kiosk-cs-sessions" class="kiosk-cs-sessions">
                                <!-- Filled by JS -->
                            </div>
                            <div id="kiosk-cs-no-session" class="kiosk-cs-no-session" style="display:none">
                                No classes scheduled today. Ask your instructor.
                            </div>
                        </div>

                        <!-- Right: recent history -->
                        <div class="kiosk-cs-right">
                            <div class="kiosk-cs-section-title">Recent Classes</div>
                            <div id="kiosk-cs-history" class="kiosk-cs-history">
                                <!-- Filled by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Check-in button -->
                    <div class="kiosk-cs-footer">
                        <button id="kiosk-cs-checkin-btn"
                                class="kiosk-cs-checkin-btn"
                                onclick="kioskClassCheckin()"
                                disabled="disabled">
                            Check In â†’
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================================
                 Instructor PIN gate overlay (client-side PIN before redirect)
            ============================================================ -->
            <div id="kiosk-instructor-gate" class="kiosk-overlay" style="display:none">
                <div class="kiosk-pin-card kiosk-gate-card">
                    <div class="kiosk-pin-title">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:6px;">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                        </svg>
                        Instructor Access
                    </div>
                    <div id="kiosk-gate-error" class="kiosk-pin-error" style="display:none">
                        Incorrect PIN. Try again.
                    </div>
                    <div class="kiosk-pin-dots" id="gate-dots">
                        <span class="pin-dot" id="gdot-0"/>
                        <span class="pin-dot" id="gdot-1"/>
                        <span class="pin-dot" id="gdot-2"/>
                        <span class="pin-dot" id="gdot-3"/>
                    </div>
                    <div class="kiosk-numpad">
                        <t t-foreach="[1,2,3,4,5,6,7,8,9,'',0,'back']" t-as="key">
                            <button t-if="key != ''" type="button"
                                    t-attf-class="kiosk-num-btn #{key == 'back' and 'kiosk-del-btn' or ''}"
                                    t-att-data-key="key"
                                    onclick="kioskGatePinKey(this.dataset.key)">
                                <t t-if="key == 'back'">&#8592;</t>
                                <t t-else=""><t t-esc="key"/></t>
                            </button>
                            <div t-else="" class="kiosk-num-empty"/>
                        </t>
                    </div>
                    <div class="kiosk-pin-actions">
                        <button type="button" class="kiosk-pin-cancel" onclick="kioskCloseGate()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Confirmation overlay (shown after check-in) -->
            <div id="kiosk-confirm" class="kiosk-overlay kiosk-confirm" style="display:none">
                <div class="kiosk-confirm-card">
                    <img id="kiosk-confirm-avatar" src="" alt="" class="kiosk-confirm-avatar"/>
                    <div id="kiosk-confirm-name"  class="kiosk-confirm-name"></div>
                    <div id="kiosk-confirm-belt"  class="kiosk-confirm-belt"></div>
                    <div id="kiosk-confirm-class" class="kiosk-confirm-class"></div>
                    <div id="kiosk-confirm-msg"   class="kiosk-confirm-msg">âœ… Checked In!</div>
                    <div class="kiosk-confirm-timer">
                        <div id="kiosk-timer-bar" class="kiosk-timer-bar"></div>
                    </div>
                </div>
            </div>

        </div><!-- /#kiosk-root -->

        <t t-set="session_id_js" t-value="selected_session.id if selected_session else 0"/>
        <script>
            var KIOSK_SESSION_ID = <t t-out="session_id_js"/>;
        </script>
        <script src="/disaster_member_belts/static/src/js/kiosk.js"></script>
        </t>
    </template>

    <!-- ================================================================
         Staff PIN exit screen
    ================================================================ -->
    <template id="kiosk_exit_pin" name="Dojo Kiosk â€“ Staff Exit">
        <t t-call="web.layout">
            <t t-set="head">
                <link rel="stylesheet" href="/disaster_member_belts/static/src/css/kiosk.css"/>
            </t>
            <t t-set="title">Staff Exit</t>
        <div class="kiosk-root kiosk-pin-screen">
            <div class="kiosk-pin-card">
                <div class="kiosk-pin-title">ðŸ”’ Staff Access</div>
                <div t-if="error" class="kiosk-pin-error">Incorrect PIN. Try again.</div>
                <form method="post" action="/dojo/kiosk/exit">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                    <!-- PIN display dots -->
                    <div class="kiosk-pin-dots" id="pin-dots">
                        <span class="pin-dot" id="dot-0"/>
                        <span class="pin-dot" id="dot-1"/>
                        <span class="pin-dot" id="dot-2"/>
                        <span class="pin-dot" id="dot-3"/>
                    </div>
                    <input type="hidden" name="pin" id="pin-value" value=""/>
                    <!-- Number pad -->
                    <div class="kiosk-numpad">
                        <t t-foreach="[1,2,3,4,5,6,7,8,9,'',0,'back']" t-as="key">
                            <button t-if="key != ''" type="button"
                                    t-attf-class="kiosk-num-btn #{key == 'back' and 'kiosk-del-btn' or ''}"
                                    t-att-data-key="key"
                                    onclick="kioskPinKey(this.dataset.key)">
                                <t t-if="key == 'back'">&#8592;</t>
                                <t t-else=""><t t-esc="key"/></t>
                            </button>
                            <div t-else="" class="kiosk-num-empty"/>
                        </t>
                    </div>
                    <div class="kiosk-pin-actions">
                        <a href="/dojo/kiosk" class="kiosk-pin-cancel">Cancel</a>
                        <button type="submit" class="kiosk-pin-submit" id="pin-submit" disabled="disabled">Confirm</button>
                    </div>
                </form>
            </div>
        </div>
        <script>
        //<![CDATA[
        var pinVal = '';
        function kioskPinKey(k) {
            if (k === 'back') { pinVal = pinVal.slice(0, -1); }
            else if (pinVal.length < 4) { pinVal += String(k); }
            document.getElementById('pin-value').value = pinVal;
            for (var i = 0; i < 4; i++) {
                document.getElementById('dot-' + i).classList.toggle('filled', i < pinVal.length);
            }
            document.getElementById('pin-submit').disabled = (pinVal.length < 4);
        }
        //]]>
        </script>
        </t>
    </template>

</odoo>
