<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================
         Inject "My Dojo" entry into the portal home page
    ================================================================ -->
    <template id="portal_my_home_dojo" name="My Dojo ‚Äì Portal Home Entry"
              inherit_id="portal.portal_my_home" priority="30">
        <xpath expr="//div[@id='portal_common_category']" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'/disaster_member_belts/static/src/img/portal-dojo.svg'"/>
                <t t-set="title">My Dojo</t>
                <t t-set="text">Belt rank, classes, progress &amp; membership</t>
                <t t-set="url" t-value="'/my/dojo'"/>
                <t t-set="config_card" t-value="True"/>
            </t>
        </xpath>
    </template>

    <!-- ================================================================
         Shared: belt rank badge macro
    ================================================================ -->
    <template id="portal_belt_badge" name="Belt Badge Macro">
        <span t-attf-class="dojo-belt-badge dojo-belt-#{rank}"
              t-attf-style="background:#{color}; color: #{rank == 'white' and '#333' or '#fff'}">
            <t t-esc="rank.capitalize()"/> Belt
        </span>
    </template>

    <!-- ================================================================
         Shared: sidebar navigation for all dojo portal pages
    ================================================================ -->
    <template id="portal_dojo_sidebar" name="Dojo Sidebar">
        <div class="dojo-portal-sidebar card border-0 shadow-sm mb-4">
            <div class="card-body p-0">
                <div t-attf-class="dojo-sidebar-header dojo-belt-#{partner.belt_rank}"
                     t-attf-style="background: #{belt_colors.get(partner.belt_rank,'#333')}">
                    <img t-att-src="image_data_uri(partner.avatar_128)"
                         class="dojo-avatar rounded-circle"
                         alt="Member Avatar"/>
                    <div class="dojo-sidebar-name mt-2 fw-bold text-white">
                        <t t-esc="partner.name"/>
                    </div>
                    <div t-attf-class="dojo-belt-label mt-1"
                         style="color: rgba(255,255,255,0.85); font-size:0.85rem">
                        <t t-esc="(partner.belt_rank or 'white').capitalize()"/> Belt
                    </div>
                </div>
                <ul class="nav flex-column p-2">
                    <li class="nav-item">
                        <a class="nav-link" t-attf-class="nav-link #{page_name == 'dojo_dashboard' and 'active fw-bold' or ''}"
                           href="/my/dojo">
                            <i class="fa fa-home me-2"/>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a t-attf-class="nav-link #{page_name == 'dojo_classes' and 'active fw-bold' or ''}"
                           href="/my/dojo/classes">
                            <i class="fa fa-calendar me-2"/>Classes &amp; Check-In
                        </a>
                    </li>
                    <li class="nav-item">
                        <a t-attf-class="nav-link #{page_name == 'dojo_progress' and 'active fw-bold' or ''}"
                           href="/my/dojo/progress">
                            <i class="fa fa-bar-chart me-2"/>My Progress
                        </a>
                    </li>
                    <li class="nav-item">
                        <a t-attf-class="nav-link #{page_name == 'dojo_contract' and 'active fw-bold' or ''}"
                           href="/my/dojo/contract">
                            <i class="fa fa-file-text-o me-2"/>Membership
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </template>

    <!-- ================================================================
         1. DASHBOARD  /my/dojo
    ================================================================ -->
    <template id="portal_member_dashboard" name="Dojo Member Dashboard">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_breadcrumbs">
                <t t-set="breadcrumbs" t-value="[{'title': 'My Dojo', 'url': '/my/dojo'}]"/>
            </t>

            <div class="container-fluid dojo-portal mt-3">
                <div class="row g-4">

                    <!-- Sidebar -->
                    <div class="col-12 col-lg-3">
                        <t t-call="disaster_member_belts.portal_dojo_sidebar"/>
                    </div>

                    <!-- Main content -->
                    <div class="col-12 col-lg-9">

                        <!-- Ready for test alert -->
                        <div t-if="ready_for_test"
                             class="alert alert-success d-flex align-items-center gap-3 mb-4" role="alert">
                            <i class="fa fa-trophy fa-2x text-warning"/>
                            <div>
                                <strong>ü•ã You're Ready to Test!</strong><br/>
                                You've met the attendance requirement for your
                                <strong><t t-esc="next_belt_rank"/> Belt</strong> grading.
                                Speak to your instructor to schedule your test.
                            </div>
                        </div>

                        <!-- Belt Progress Card -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header d-flex align-items-center gap-2">
                                <i class="fa fa-certificate text-warning"/>
                                <strong>Belt Rank Progress</strong>
                            </div>
                            <div class="card-body">
                                <!-- Belt steps -->
                                <div class="dojo-belt-steps d-flex gap-1 mb-3 flex-wrap">
                                    <t t-foreach="belt_order" t-as="rank">
                                        <div t-attf-class="dojo-belt-step #{rank == current_rank and 'active' or ''} #{belt_order.index(rank) &lt; belt_order.index(current_rank) and 'done' or ''}"
                                             t-attf-style="background:#{belt_colors.get(rank,'#ccc')}; color: #{rank == 'white' and '#333' or '#fff'}"
                                             t-att-title="rank.capitalize()">
                                            <t t-esc="rank[:1].upper()"/>
                                        </div>
                                    </t>
                                </div>
                                <!-- Progress bar -->
                                <div class="d-flex justify-content-between small text-muted mb-1">
                                    <span>Sessions toward <t t-esc="next_belt_rank"/> Belt</span>
                                    <span><t t-esc="attendance_count"/>/<t t-esc="threshold"/> sessions</span>
                                </div>
                                <div class="progress" style="height:18px">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                         t-attf-style="width:#{progress_pct}%; background:#{belt_colors.get(current_rank,'#007bff')}"
                                         role="progressbar">
                                        <t t-esc="progress_pct"/>%
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats row -->
                        <div class="row g-3 mb-4">
                            <div class="col-4">
                                <div class="card text-center shadow-sm h-100">
                                    <div class="card-body">
                                        <div class="display-5 fw-bold text-primary">
                                            <t t-esc="attendance_count"/>
                                        </div>
                                        <div class="small text-muted">Total Sessions</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card text-center shadow-sm h-100">
                                    <div class="card-body">
                                        <div class="display-5 fw-bold text-success">
                                            <t t-esc="rank_idx + 1"/>/<t t-esc="len(belt_order)"/>
                                        </div>
                                        <div class="small text-muted">Belt Level</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card text-center shadow-sm h-100">
                                    <div class="card-body">
                                        <div class="display-5 fw-bold text-warning">
                                            <t t-esc="max(0, threshold - attendance_count)"/>
                                        </div>
                                        <div class="small text-muted">Sessions to Test</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upcoming Classes -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header d-flex align-items-center justify-content-between">
                                <span><i class="fa fa-calendar me-2"/>Upcoming Classes</span>
                                <a href="/my/dojo/classes" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                            <div class="card-body p-0">
                                <t t-if="not upcoming_sessions">
                                    <p class="text-muted p-3 mb-0">No upcoming classes scheduled.</p>
                                </t>
                                <t t-else="">
                                    <div class="list-group list-group-flush">
                                        <t t-foreach="upcoming_sessions[:5]" t-as="session">
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong><t t-esc="session.name"/></strong>
                                                    <div class="small text-muted">
                                                        <t t-esc="session.date_start" t-options='{"widget":"datetime"}'/>
                                                        <span class="ms-2"><t t-esc="session.location"/></span>
                                                    </div>
                                                </div>
                                                <a t-attf-href="/my/dojo/classes" class="btn btn-sm btn-outline-success">
                                                    Check In
                                                </a>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </div>
                        </div>

                        <!-- Recent Attendance -->
                        <div class="card shadow-sm">
                            <div class="card-header d-flex align-items-center justify-content-between">
                                <span><i class="fa fa-history me-2"/>Recent Attendance</span>
                                <a href="/my/dojo/progress" class="btn btn-sm btn-outline-primary">Full History</a>
                            </div>
                            <div class="card-body p-0">
                                <t t-if="not recent_attendance">
                                    <p class="text-muted p-3 mb-0">No attendance records yet. Come to class!</p>
                                </t>
                                <t t-else="">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Class</th>
                                                    <th>Date</th>
                                                    <th>Belt at Check-in</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="recent_attendance" t-as="att">
                                                    <tr>
                                                        <td><t t-esc="att.session_id.name"/></td>
                                                        <td><t t-esc="att.check_in" t-options='{"widget":"datetime"}'/></td>
                                                        <td>
                                                            <span t-attf-class="badge dojo-belt-badge-sm dojo-belt-#{att.belt_rank_at_checkin}">
                                                                <t t-esc="(att.belt_rank_at_checkin or '').capitalize()"/>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>
                            </div>
                        </div>

                    </div><!-- /main -->
                </div><!-- /row -->
            </div>
        </t>
    </template>

    <!-- ================================================================
         2. CLASSES  /my/dojo/classes
    ================================================================ -->
    <template id="portal_member_classes" name="Dojo ‚Äì Classes &amp; Check-In">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_breadcrumbs">
                <t t-set="breadcrumbs" t-value="[
                    {'title': 'My Dojo', 'url': '/my/dojo'},
                    {'title': 'Classes'}]"/>
            </t>

            <div class="container-fluid dojo-portal mt-3">
                <div class="row g-4">
                    <div class="col-12 col-lg-3">
                        <t t-call="disaster_member_belts.portal_dojo_sidebar"/>
                    </div>
                    <div class="col-12 col-lg-9">

                        <!-- Success / Error alerts -->
                        <div t-if="request.params.get('success') == 'checked_in'"
                             class="alert alert-success">
                            ‚úÖ You've been checked in successfully!
                        </div>
                        <div t-if="request.params.get('error') == 'session_unavailable'"
                             class="alert alert-danger">
                            ‚ùå That session is no longer available.
                        </div>

                        <h4 class="mb-3"><i class="fa fa-calendar me-2"/>Upcoming Classes</h4>

                        <t t-if="not sessions">
                            <div class="alert alert-info">
                                No upcoming classes scheduled. Check back soon!
                            </div>
                        </t>
                        <t t-else="">
                            <div class="row g-3">
                                <t t-foreach="sessions" t-as="session">
                                    <div class="col-12 col-md-6">
                                        <div t-attf-class="card h-100 shadow-sm #{session.id in checked_in_ids and 'border-success' or ''}">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <strong><t t-esc="session.name"/></strong>
                                                <span t-attf-class="badge #{session.state == 'in_progress' and 'bg-success' or 'bg-primary'}">
                                                    <t t-esc="session.state.replace('_',' ').title()"/>
                                                </span>
                                            </div>
                                            <div class="card-body">
                                                <p class="mb-1">
                                                    <i class="fa fa-clock-o me-1 text-muted"/>
                                                    <t t-esc="session.date_start" t-options='{"widget":"datetime"}'/>
                                                </p>
                                                <p class="mb-1">
                                                    <i class="fa fa-map-marker me-1 text-muted"/>
                                                    <t t-esc="session.location or 'Main Dojo'"/>
                                                </p>
                                                <p class="mb-1">
                                                    <i class="fa fa-user me-1 text-muted"/>
                                                    <t t-esc="session.instructor_id.name or 'TBD'"/>
                                                </p>
                                                <p class="mb-0 small text-muted">
                                                    <i class="fa fa-users me-1"/>
                                                    <t t-esc="session.attendance_count"/>/<t t-esc="session.capacity"/> checked in
                                                </p>
                                            </div>
                                            <div class="card-footer">
                                                <t t-if="session.id in checked_in_ids">
                                                    <span class="text-success fw-bold">
                                                        <i class="fa fa-check-circle me-1"/>Already Checked In
                                                    </span>
                                                </t>
                                                <t t-else="">
                                                    <form t-attf-action="/my/dojo/checkin/#{session.id}"
                                                          method="post">
                                                        <input type="hidden" name="csrf_token"
                                                               t-att-value="request.csrf_token()"/>
                                                        <button type="submit"
                                                                class="btn btn-success btn-sm w-100">
                                                            <i class="fa fa-sign-in me-1"/>Check In Now
                                                        </button>
                                                    </form>
                                                </t>
                                            </div>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ================================================================
         3. PROGRESS  /my/dojo/progress
    ================================================================ -->
    <template id="portal_member_progress" name="Dojo ‚Äì My Progress">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_breadcrumbs">
                <t t-set="breadcrumbs" t-value="[
                    {'title': 'My Dojo', 'url': '/my/dojo'},
                    {'title': 'My Progress'}]"/>
            </t>

            <div class="container-fluid dojo-portal mt-3">
                <div class="row g-4">
                    <div class="col-12 col-lg-3">
                        <t t-call="disaster_member_belts.portal_dojo_sidebar"/>
                    </div>
                    <div class="col-12 col-lg-9">

                        <!-- Belt Journey -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header"><strong><i class="fa fa-road me-2"/>Belt Journey</strong></div>
                            <div class="card-body">
                                <div class="dojo-belt-timeline d-flex align-items-center gap-1 flex-wrap">
                                    <t t-foreach="belt_order" t-as="rank">
                                        <t t-set="is_done" t-value="belt_order.index(rank) &lt; rank_idx"/>
                                        <t t-set="is_current" t-value="rank == current_rank"/>
                                        <div t-attf-class="dojo-timeline-node #{is_current and 'current' or ''} #{is_done and 'done' or ''}"
                                             t-attf-style="background:#{belt_colors.get(rank,'#ccc')}; color:#{rank=='white' and '#333' or '#fff'}">
                                            <span class="dojo-timeline-label"><t t-esc="rank.capitalize()"/></span>
                                            <i t-if="is_done" class="fa fa-check dojo-timeline-check"/>
                                            <i t-if="is_current" class="fa fa-star dojo-timeline-star"/>
                                        </div>
                                        <t t-if="not rank_as_last">
                                            <div class="dojo-timeline-arrow text-muted">‚Ä∫</div>
                                        </t>
                                    </t>
                                </div>
                                <!-- Progress bar to next rank -->
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between small text-muted mb-1">
                                        <span><t t-esc="current_rank.capitalize()"/> ‚Üí <t t-esc="next_belt_rank"/></span>
                                        <span><t t-esc="attendance_count"/>/<t t-esc="threshold"/> sessions</span>
                                    </div>
                                    <div class="progress" style="height:20px">
                                        <div class="progress-bar"
                                             t-attf-style="width:#{progress_pct}%; background:#{belt_colors.get(current_rank,'#007bff')}"
                                             role="progressbar">
                                            <t t-esc="progress_pct"/>%
                                        </div>
                                    </div>
                                    <div t-if="ready_for_test" class="alert alert-success mt-2 mb-0 py-2">
                                        üéâ <strong>Ready to Test!</strong> Ask your instructor to schedule your grading.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Full Attendance History -->
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <strong><i class="fa fa-list me-2"/>Full Attendance History</strong>
                                <span class="badge bg-secondary ms-2"><t t-esc="len(all_attendance)"/> sessions</span>
                            </div>
                            <div class="card-body p-0">
                                <t t-if="not all_attendance">
                                    <p class="text-muted p-3 mb-0">No attendance records yet.</p>
                                </t>
                                <t t-else="">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Class</th>
                                                    <th>Type</th>
                                                    <th>Date</th>
                                                    <th>Belt</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="all_attendance" t-as="att">
                                                    <tr>
                                                        <td class="text-muted"><t t-esc="len(all_attendance) - att_index"/></td>
                                                        <td><t t-esc="att.session_id.name"/></td>
                                                        <td class="text-capitalize"><t t-esc="(att.class_type or '').replace('_',' ')"/></td>
                                                        <td><t t-esc="att.check_in" t-options='{"widget":"datetime"}'/></td>
                                                        <td>
                                                            <span t-attf-class="badge dojo-belt-badge-sm dojo-belt-#{att.belt_rank_at_checkin}">
                                                                <t t-esc="(att.belt_rank_at_checkin or '').capitalize()"/>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ================================================================
         4. CONTRACT  /my/dojo/contract
    ================================================================ -->
    <template id="portal_member_contract" name="Dojo ‚Äì Membership">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_breadcrumbs">
                <t t-set="breadcrumbs" t-value="[
                    {'title': 'My Dojo', 'url': '/my/dojo'},
                    {'title': 'Membership'}]"/>
            </t>

            <div class="container-fluid dojo-portal mt-3">
                <div class="row g-4">
                    <div class="col-12 col-lg-3">
                        <t t-call="disaster_member_belts.portal_dojo_sidebar"/>
                    </div>
                    <div class="col-12 col-lg-9">

                        <!-- Active contract -->
                        <t t-if="active_contract">
                            <div class="card shadow-sm mb-4 border-success">
                                <div class="card-header bg-success text-white d-flex justify-content-between">
                                    <strong><i class="fa fa-check-circle me-2"/>Active Membership</strong>
                                    <span class="badge bg-light text-success">
                                        <t t-esc="active_contract.state.capitalize()"/>
                                    </span>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-6">
                                            <div class="text-muted small">Plan</div>
                                            <div class="fw-bold"><t t-esc="active_contract.plan_id.name"/></div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted small">Price</div>
                                            <div class="fw-bold">
                                                <t t-esc="active_contract.price"
                                                   t-options='{"widget":"monetary","display_currency":active_contract.currency_id}'/>
                                                / <t t-esc="active_contract.billing_cycle"/>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted small">Start Date</div>
                                            <div><t t-esc="active_contract.date_start" t-options='{"widget":"date"}'/></div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted small">
                                                <t t-if="active_contract.state == 'trial'">Trial Ends</t>
                                                <t t-else="">Contract Ends</t>
                                            </div>
                                            <div>
                                                <t t-esc="active_contract.trial_end_date or active_contract.date_end"
                                                   t-options='{"widget":"date"}'/>
                                            </div>
                                        </div>
                                        <div t-if="active_contract.next_billing_date" class="col-6">
                                            <div class="text-muted small">Next Billing</div>
                                            <div><t t-esc="active_contract.next_billing_date" t-options='{"widget":"date"}'/></div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted small">Belt Program</div>
                                            <div>
                                                <t t-if="active_contract.belt_program">
                                                    <span class="text-success"><i class="fa fa-check me-1"/>Included</span>
                                                </t>
                                                <t t-else="">
                                                    <span class="text-muted"><i class="fa fa-times me-1"/>Not included</span>
                                                </t>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                        <t t-else="">
                            <div class="alert alert-warning mb-4">
                                <i class="fa fa-exclamation-triangle me-2"/>
                                You have no active membership. Please contact the dojo to renew or sign up.
                            </div>
                        </t>

                        <!-- All contracts history -->
                        <div class="card shadow-sm">
                            <div class="card-header"><strong><i class="fa fa-history me-2"/>Membership History</strong></div>
                            <div class="card-body p-0">
                                <t t-if="not contracts">
                                    <p class="text-muted p-3 mb-0">No contract history.</p>
                                </t>
                                <t t-else="">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Plan</th>
                                                    <th>Start</th>
                                                    <th>End</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="contracts" t-as="c">
                                                    <tr>
                                                        <td><t t-esc="c.plan_id.name"/></td>
                                                        <td><t t-esc="c.date_start" t-options='{"widget":"date"}'/></td>
                                                        <td><t t-esc="c.date_end" t-options='{"widget":"date"}'/></td>
                                                        <td>
                                                            <span t-attf-class="badge #{
                                                                c.state == 'active' and 'bg-success' or
                                                                c.state == 'trial' and 'bg-warning text-dark' or
                                                                c.state == 'expired' and 'bg-secondary' or
                                                                'bg-danger'}">
                                                                <t t-esc="c.state.capitalize()"/>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </t>
    </template>

</odoo>
