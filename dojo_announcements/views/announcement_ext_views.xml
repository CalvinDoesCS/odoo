<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Extend announcement form with dispatch controls -->
    <record id="view_announcement_dojo_ext" model="ir.ui.view">
        <field name="name">disaster.announcement.dojo.ext</field>
        <field name="model">disaster.announcement</field>
        <field name="inherit_id" ref="disaster_member_belts.view_announcement_form"/>
        <field name="arch" type="xml">

            <!-- Add dispatch button in header -->
            <xpath expr="//header" position="inside">
                <button name="action_dispatch" type="object"
                        string="Dispatch Now"
                        class="btn-primary"
                        invisible="dojo_dispatched or not active"/>
                <span class="badge text-bg-success ms-2"
                      invisible="not dojo_dispatched">Dispatched</span>
            </xpath>

            <!-- Add channel / audience fields -->
            <xpath expr="//sheet//group[last()]" position="after">
                <group string="Channels &amp; Targeting">
                    <group string="Dispatch Channels">
                        <field name="dojo_send_in_app" widget="boolean_toggle"/>
                        <field name="dojo_send_push" widget="boolean_toggle"/>
                        <field name="dojo_send_email" widget="boolean_toggle"/>
                        <field name="dojo_send_sms" widget="boolean_toggle"/>
                    </group>
                    <group string="Scheduling">
                        <field name="dojo_publish_dt"/>
                        <field name="dojo_expire_dt"/>
                        <field name="dojo_audience_domain"
                               placeholder='e.g. [("belt_rank","=","blue")]'/>
                        <field name="dojo_audience_preview_count" readonly="1"/>
                        <field name="dojo_dispatched" readonly="1"/>
                    </group>
                </group>
            </xpath>

        </field>
    </record>

    <!-- Dispatch action from list -->
    <record id="action_announcement_dispatch" model="ir.actions.server">
        <field name="name">Dispatch Selected</field>
        <field name="model_id" ref="disaster_member_belts.model_disaster_announcement"/>
        <field name="binding_model_id" ref="disaster_member_belts.model_disaster_announcement"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">records.action_dispatch()</field>
    </record>

</odoo>
